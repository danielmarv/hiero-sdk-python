name: PR Protobuf Contract + CodeRabbit Gate

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: protobuf-coderabbit-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  protobuf-contract-gate:
    name: Protobuf Contract Gate
    runs-on: ubuntu-latest

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@a90bcbc6539c36a85cdfeb73f7e2f433735f215b # v2.15.0
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Set up buf
        uses: bufbuild/buf-setup-action@v1
        with:
          version: 1.57.0

      - name: Ensure main ref for breaking-change comparison
        run: git fetch --no-tags --prune --depth=1 origin main:refs/remotes/origin/main

      - name: Prepare protobuf change metadata
        shell: bash
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          set -euo pipefail

          files_path="${RUNNER_TEMP}/protobuf_changed_files.txt"
          diff_path="${RUNNER_TEMP}/protobuf_contract.diff"

          git diff --name-only "${BASE_SHA}" "${HEAD_SHA}" -- '*.proto' | sort -u > "${files_path}"
          git diff "${BASE_SHA}" "${HEAD_SHA}" -- '*.proto' > "${diff_path}"

          echo "BASE_SHA=${BASE_SHA}" >> "${GITHUB_ENV}"
          echo "HEAD_SHA=${HEAD_SHA}" >> "${GITHUB_ENV}"
          echo "PROTOBUF_FILES_PATH=${files_path}" >> "${GITHUB_ENV}"
          echo "PROTOBUF_DIFF_PATH=${diff_path}" >> "${GITHUB_ENV}"

      - name: Remove stale ready-for-coderabbit label
        if: github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const label = "ready-for-coderabbit";
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.pull_request.number;
            try {
              await github.rest.issues.removeLabel({
                owner,
                repo,
                issue_number: issueNumber,
                name: label,
              });
              core.info(`Removed stale label '${label}' from PR #${issueNumber}.`);
            } catch (error) {
              if (error?.status === 404) {
                core.info(`Label '${label}' not present on PR #${issueNumber}.`);
              } else {
                throw error;
              }
            }

      - name: buf lint
        run: buf lint

      - name: buf breaking (against main)
        run: buf breaking --against ".git#ref=origin/main"

      - name: buf build
        run: buf build

      - name: Add ready-for-coderabbit label
        if: github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const label = "ready-for-coderabbit";
            const { owner, repo } = context.repo;
            const issueNumber = context.payload.pull_request.number;

            try {
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: [label],
              });
              core.info(`Added label '${label}' to PR #${issueNumber}.`);
            } catch (error) {
              if (error?.status !== 422) {
                throw error;
              }

              await github.rest.issues.createLabel({
                owner,
                repo,
                name: label,
                color: "0E8A16",
                description: "Protobuf contract checks passed; ready for CodeRabbit review.",
              }).catch((createError) => {
                if (createError?.status !== 422) {
                  throw createError;
                }
              });

              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: [label],
              });
              core.info(`Created and added label '${label}' to PR #${issueNumber}.`);
            }

      - name: Trigger protobuf-driven CodeRabbit review
        if: github.event.pull_request.head.repo.fork == false
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          BASE_SHA: ${{ env.BASE_SHA }}
          HEAD_SHA: ${{ env.HEAD_SHA }}
          PROTOBUF_DIFF_PATH: ${{ env.PROTOBUF_DIFF_PATH }}
          PROTOBUF_FILES_PATH: ${{ env.PROTOBUF_FILES_PATH }}
          PROTOBUF_SCOPE_MODE: contract-first
          PROTOBUF_SCOPE_REASON: Triggered only after buf lint, buf breaking, and buf build passed.
        with:
          script: |
            const script = require('./.github/scripts/pr-protobuf-coderabbit-review.js');
            await script({ github, context });

      - name: Note fork limitation
        if: github.event.pull_request.head.repo.fork == true
        run: echo "::notice::Skipping label/comment handoff for fork PRs because pull_request tokens are read-only."
